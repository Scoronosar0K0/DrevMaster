# DrevMaster - Инструкция по деплою

## Требования к серверу

- Node.js 18.x или выше
- npm или yarn
- SQLite3 (встроен в проект)
- Apache с mod_rewrite (для Timeweb)

## Шаги деплоя на Timeweb

### 1. Загрузка файлов

Разархивируйте `drevmaster-deploy.zip` в корневую папку вашего домена.

### 2. Установка зависимостей

```bash
npm install
```

### 3. Настройка переменных окружения

Создайте файл `.env.local`:

```
JWT_SECRET=drevmaster-secret-key-2024
NODE_ENV=production
PORT=3000
```

### 4. Настройка прав доступа

```bash
chmod +x start.sh
chmod 644 .htaccess
chmod 666 drevmaster.db
```

### 5. Запуск приложения

**Вариант 1: Обычный запуск**

```bash
./start.sh
```

**Вариант 2: PM2 (рекомендуется)**

```bash
npm install -g pm2
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**Вариант 3: Systemd сервис**

```bash
npm start
```

### 6. Проверка

#### Проверка процесса:

```bash
ps aux | grep node
```

#### Проверка логов:

```bash
tail -f app.log
```

#### Проверка порта:

```bash
netstat -tlnp | grep 3000
```

### 7. Решение проблемы "Forbidden"

**Если получаете ошибку 403 Forbidden:**

1. **Проверьте .htaccess файл** - он должен быть в корне домена
2. **Убедитесь что приложение запущено** на порту 3000
3. **Проверьте настройки Timeweb**:

   - В панели управления включите поддержку Node.js
   - Укажите точку входа: `npm start`
   - Проверьте что домен направлен на правильную папку

4. **Альтернативный .htaccess для статического контента:**

```apache
DirectoryIndex index.html
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]
```

5. **Для поддоменов Node.js приложений:**
   - Создайте поддомен в панели Timeweb
   - Настройте его на порт 3000
   - Используйте прокси настройки

### 8. Альтернативный деплой (Static Export)

Если Node.js приложения не поддерживаются:

```bash
# Создать статический экспорт
npm run build
npm run export

# Загрузить содержимое папки out/ на сервер
```

## Инициализация базы данных

База данных SQLite уже создана и настроена. Файл `drevmaster.db` содержит:

- Администратор: логин `admin`, пароль `admin`
- Все необходимые таблицы

## Структура проекта

- `/app` - основное приложение Next.js
- `/lib` - утилиты и конфигурация базы данных
- `/components` - React компоненты
- `drevmaster.db` - база данных SQLite
- `.next` - скомпилированное приложение
- `.htaccess` - конфигурация Apache
- `start.sh` - скрипт запуска

## Диагностика проблем

### Ошибка "Forbidden" (403)

- Проверьте права доступа к файлам
- Убедитесь что .htaccess корректный
- Проверьте что Node.js приложение запущено
- Попробуйте доступ через IP:3000

### Ошибка "Cannot connect"

- Проверьте что процесс Node.js запущен
- Проверьте порт 3000
- Проверьте файрвол

### Ошибка базы данных

- Проверьте права на файл drevmaster.db
- Убедитесь что SQLite установлен

## Безопасность

⚠️ **ВАЖНО**: После деплоя обязательно:

1. Смените пароль администратора
2. Измените JWT_SECRET в `.env.local`
3. Настройте правильный домен в конфигурации
4. Ограничьте доступ к файлу базы данных

## Поддержка Timeweb

- **Тариф**: Убедитесь что Node.js поддерживается
- **Домены**: Настройте домен или поддомен
- **Порты**: Может потребоваться настройка прокси
- **Логи**: Проверяйте логи в панели управления

## Контакты поддержки

При возникновении проблем проверьте:

1. Версию Node.js (должна быть 18+)
2. Права доступа к файлам базы данных
3. Логи сервера (`app.log`)
4. Настройки домена в Timeweb
